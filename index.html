<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>The 1% — Demo</title>
  <meta name="description" content="The 1% — fantasy trading simulation demo"/>
  <link rel="icon" href="data:,">
  <style>
    :root { --bg:#F3F5FA; --card:rgba(255,255,255,.65); --ink:#0B0C0F; }
    *{box-sizing:border-box}
    body{margin:0;font:16px/1.45 -apple-system,BlinkMacSystemFont,Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--ink);background:linear-gradient(180deg,#F8FAFF,var(--bg))}
    .topbar{position:sticky;top:0;height:56px;display:flex;align-items:center;justify-content:space-between;padding:0 20px;background:rgba(255,255,255,.72);backdrop-filter:saturate(140%) blur(12px);border-bottom:1px solid rgba(0,0,0,.06)}
    .wrap{max-width:1100px;margin:60px auto 120px;padding:0 24px}
    h1{margin:0 0 8px;font-size:34px;letter-spacing:-.5px}
    .lead{margin:0;opacity:.7;max-width:760px}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
    .card{border-radius:20px;background:var(--card);border:1px solid rgba(0,0,0,.06);padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.06), inset 0 0 0 .5px rgba(255,255,255,.35);backdrop-filter:blur(12px)}
    .section{display:flex;align-items:baseline;justify-content:space-between;margin-bottom:12px}
    .title{font-weight:800;letter-spacing:-.3px}
    .sub{font-size:12px;opacity:.6}
    .quotes{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .qbox{border-radius:16px;padding:16px;background:rgba(255,255,255,.55);border:1px solid rgba(0,0,0,.05);box-shadow:inset 0 1px 0 rgba(255,255,255,.5)}
    .input,select,button{height:44px;border-radius:12px;border:1px solid rgba(0,0,0,.08);background:rgba(255,255,255,.9);padding:0 12px;outline:none}
    .field{border-radius:12px;background:rgba(255,255,255,.75);border:1px solid rgba(0,0,0,.06);padding:12px}
    .row{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:12px}
    .actions{display:flex;gap:12px;margin-top:12px}
    .btn{height:44px;border-radius:12px;border:none;color:#fff;font-weight:700;cursor:pointer;box-shadow:0 8px 20px rgba(0,0,0,.06)}
    .buy{background:linear-gradient(180deg,#38ef7d,#11998e)}
    .sell{background:linear-gradient(180deg,#ff5858,#f857a6)}
    .tableH,.tableR{display:grid;grid-template-columns:1fr repeat(6,1fr);gap:0;padding:10px 8px}
    .tableH{font-size:12px;opacity:.7;padding-top:6px;padding-bottom:6px}
    .tableR{border-radius:12px;background:rgba(255,255,255,.55);border:1px solid rgba(0,0,0,.05);margin-bottom:8px}
    .lbRow{display:flex;align-items:center;gap:12px;padding:12px;border-radius:12px;background:rgba(255,255,255,.55);border:1px solid rgba(0,0,0,.05)}
    .tag{font-size:12px;padding:4px 8px;border-radius:999px;background:rgba(0,0,0,.06);display:inline-block;cursor:default}
    .toast{position:fixed;left:50%;bottom:30px;transform:translateX(-50%);padding:12px 16px;background:rgba(0,0,0,.85);color:#fff;border-radius:12px;box-shadow:0 10px 20px rgba(0,0,0,.2)}
    .footer{position:fixed;left:0;right:0;bottom:0;height:48px;display:flex;align-items:center;justify-content:space-between;padding:0 20px;background:rgba(255,255,255,.72);backdrop-filter:saturate(140%) blur(12px);border-top:1px solid rgba(0,0,0,.06)}
    @media (max-width:900px){.grid{grid-template-columns:1fr}.row{grid-template-columns:1fr 1fr}.quotes{grid-template-columns:1fr}}
    /* Help popups */
    .help-pop{position:absolute;z-index:9999;max-width:220px;background:rgba(20,20,25,.96);color:#fff;padding:8px 10px;border-radius:10px;font-size:12px;line-height:1.25;box-shadow:0 8px 24px rgba(0,0,0,.25);transform:translate(-50%,-120%)}
    .help-pop::after{content:"";position:absolute;left:50%;bottom:-6px;transform:translateX(-50%);width:0;height:0;border-left:6px solid transparent;border-right:6px solid transparent;border-top:6px solid rgba(20,20,25,.96)}
  </style>
</head>
<body>
  <div class="topbar">
    <div style="font-weight:700">The 1%</div>
    <div style="opacity:.7">prototype</div>
  </div>

  <div class="wrap">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
      <div>
        <h1>Trade like the 1%</h1>
        <p class="lead">
          A lightweight prototype of <b>The 1%</b> — a <b>fantasy trading simulation</b> where players experiment with market moves in a simple browser demo.
          This experience uses simulated prices for demonstration only.
        </p>
      </div>
    </div>

    <!-- Candlestick Chart -->
    <div id="chartCard" class="card" style="grid-column:span 3">
      <div class="section">
        <div class="title" style="display:flex;gap:12px;align-items:center">
          Market — <span id="chartSymbol">AAPL</span>
          <button class="tag" data-help="Tap a symbol to change chart">?</button>
        </div>
        <div class="sub" style="display:flex;gap:8px;align-items:center">
          <button class="tag symBtn" data-sym="AAPL">AAPL</button>
          <button class="tag symBtn" data-sym="NVDA">NVDA</button>
          <button class="tag symBtn" data-sym="TSLA">TSLA</button>
        </div>
      </div>
      <div id="candleWrap" style="height:300px"></div>
    </div>

    <!-- Quotes -->
    <div id="quotesCard" class="card" style="grid-column:span 3">
      <div class="section"><div><div class="title">Quotes <button class="tag" data-help="Live demo prices update each second">?</button></div><div class="sub">Simulated</div></div></div>
      <div id="quotes" class="quotes"></div>
    </div>

    <!-- Trade -->
    <div id="tradeCard" class="card" style="grid-column:span 2">
      <div class="section">
        <div class="title">Trade <button class="tag" data-help="Pick symbol and micros; press Buy or Sell">?</button></div>
        <div class="sub">Micros (demo)</div>
      </div>
      <div class="row">
        <select id="symSelect"></select>
        <input id="microsInput" class="input" inputmode="numeric" value="10000"/>
        <div class="field">
          <div style="font-size:12px;opacity:.7">Estimated notional</div>
          <div id="estNotional" style="font-weight:700">0 Bucks</div>
        </div>
        <div class="field">
          <div style="font-size:12px;opacity:.7">Fee (0.05%)</div>
          <div id="estFee" style="font-weight:700">0 Bucks</div>
        </div>
      </div>
      <div class="actions">
        <button id="buyBtn" class="btn buy">Buy</button>
        <button id="sellBtn" class="btn sell">Sell</button>
      </div>
    </div>

    <!-- Leverage -->
    <div id="levCard" class="card" style="grid-column:span 2">
      <div class="section">
        <div class="title">Leverage <button class="tag" data-help="Borrowed Bucks for today; caps your exposure">?</button></div>
        <div class="sub">Sets today’s borrowed Bucks; caps total exposure</div>
      </div>
      <div class="row">
        <div class="field">
          <div style="font-size:12px;opacity:.7">Leverage (1–5×)</div>
          <input id="levSlider" class="input" type="range" min="1" max="5" step="0.5" value="2"/>
        </div>
        <div class="field">
          <div style="font-size:12px;opacity:.7">Current</div>
          <div id="levRead" style="font-weight:700">2.0×</div>
        </div>
        <div class="field">
          <div style="font-size:12px;opacity:.7">Borrowed Bucks</div>
          <div id="levBorrowed" style="font-weight:700">0 Bucks</div>
        </div>
        <div class="field">
          <div style="font-size:12px;opacity:.7">Max Exposure</div>
          <div id="levMaxExp" style="font-weight:700">0 Bucks</div>
        </div>
      </div>
    </div>

    <!-- Session P&L & Flow -->
    <div id="pnlCard" class="card" style="grid-column:span 2">
      <div class="section">
        <div class="title">Session P&L <button class="tag" data-help="Profit/loss since start; flow is total traded Bucks">?</button></div>
        <div class="sub">Realized + Unrealized • Flow = total traded Bucks</div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:12px">
        <div class="field"><div style="font-size:12px;opacity:.7">Realized P&L</div><div id="realizedPnL" style="font-size:20px;font-weight:700">0 Bucks</div></div>
        <div class="field"><div style="font-size:12px;opacity:.7">Unrealized P&L</div><div id="unrealizedPnL" style="font-size:20px;font-weight:700">0 Bucks</div></div>
        <div class="field"><div style="font-size:12px;opacity:.7">Flow (Volume)</div><div id="flowVol" style="font-size:20px;font-weight:700">0 Bucks</div></div>
      </div>
      <div class="field">
        <div style="font-size:12px;opacity:.7;display:flex;justify-content:space-between">
          <span>Equity Sparkline</span>
          <span id="equityPct" style="font-weight:700">+0.00%</span>
        </div>
        <canvas id="equityLine" height="60" style="width:100%"></canvas>
      </div>
    </div>

    <!-- Account -->
    <div id="acctCard" class="card">
      <div class="section"><div class="title">Account <button class="tag" data-help="Balance plus positions equals your equity">?</button></div><div class="sub">Profile</div></div>
      <div style="display:grid;gap:12px">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
          <div><div style="font-size:12px;opacity:.7">Handle</div><input id="handle" class="input" value="player"/></div>
          <div><div style="font-size:12px;opacity:.7">Mode</div><span class="tag">DEMO</span></div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
          <div class="field"><div style="font-size:12px;opacity:.7">Balance</div><div id="balance" style="font-size:20px;font-weight:700">0 Bucks</div></div>
          <div class="field"><div style="font-size:12px;opacity:.7">Equity</div><div id="equity" style="font-size:20px;font-weight:700">0 Bucks</div></div>
        </div>
        <div style="font-size:12px;opacity:.7;border-top:1px solid rgba(0,0,0,.06);padding-top:8px">
          This is a fantasy trading simulation for demonstration purposes only. Not financial advice. Not affiliated with any companies or exchanges.
        </div>
      </div>
    </div>

    <!-- Portfolio -->
    <div id="portCard" class="card" style="grid-column:span 2">
      <div class="section"><div class="title">Portfolio <button class="tag" data-help="Positions with value and P&L. Green good; red bad">?</button></div><div class="sub">Live P&amp;L</div></div>
      <div class="tableH"><div>Symbol</div><div style="text-align:right">Micros</div><div style="text-align:right">Shares</div><div style="text-align:right">Avg</div><div style="text-align:right">Last</div><div style="text-align:right">Value</div><div style="text-align:right">P&amp;L</div></div>
      <div id="portRows"></div>
      <div style="display:grid;grid-template-columns:1fr auto;margin-top:8px"><div style="font-size:12px;opacity:.7">Balance</div><div id="balance2" style="font-weight:700">0 Bucks</div></div>
      <div style="display:grid;grid-template-columns:1fr auto"><div style="font-size:12px;opacity:.7">Equity</div><div id="equity2" style="font-weight:700">0 Bucks</div></div>
    </div>

    <!-- Leaderboard -->
    <div id="lbCard" class="card">
      <div class="section"><div class="title">Leaderboard <button class="tag" data-help="Your return vs rivals. Demo only">?</button></div><div class="sub">(local demo)</div></div>
      <div id="lbRows"></div>
    </div>
  </div>

  <div class="footer">
    <div>© <span id="year"></span> The 1%</div>
    <div style="opacity:.6">Prototype UI</div>
  </div>

  <div id="toast" class="toast" style="display:none"></div>

  <!-- Lightweight candlestick charts -->
  <script src="https://unpkg.com/lightweight-charts@4.2.0/dist/lightweight-charts.standalone.production.js"></script>

  <script>
    // ------- Utilities & constants -------
    const TICKERS = [
      { symbol:"AAPL", name:"Apple" },
      { symbol:"NVDA", name:"Nvidia" },
      { symbol:"TSLA", name:"Tesla" },
    ];
    const MICRO = 0.0001;         // 1 micro-share = 0.0001 share
    const FEE_RATE = 0.0005;      // 0.05%
    const fmt = (n,d=2)=>Number(n).toLocaleString(undefined,{minimumFractionDigits:d,maximumFractionDigits:d});
    const el = id => document.getElementById(id);

    // ------- State -------
    const state = {
      quotes: Object.fromEntries(TICKERS.map(t=>[t.symbol, 180+Math.random()*40])),
      lastUpdate: new Date(),
      balance: 10_000_000,            // Bucks
      positions: {},                  // sym -> { micros, avgPrice }
      leverage: 2,                    // 2x default
      realizedPnL: 0,                 // Bucks
      volume: 0,                      // Bucks traded
      equityHigh: null,               // session high
      equitySeries: []                // for sparkline
    };

    // ------- Sounds (Web Audio, no files) -------
    let _audioCtx;
    function audio(){ if(!_audioCtx) _audioCtx = new (window.AudioContext||window.webkitAudioContext)(); return _audioCtx; }
    function tone(freq=880, dur=0.15, type='sine', vol=0.05){
      const ctx = audio(); const o = ctx.createOscillator(); const g = ctx.createGain();
      o.type = type; o.frequency.value = freq; g.gain.value = vol;
      o.connect(g); g.connect(ctx.destination); o.start(); setTimeout(()=>o.stop(), dur*1000);
    }
    function playWinChime(){ tone(1100,0.12,'triangle',0.07); setTimeout(()=>tone(1400,0.12,'triangle',0.06), 120); }
    function playWinAlert(){ tone(900,0.1,'square',0.06); setTimeout(()=>tone(1200,0.18,'square',0.06), 90); }
    function playLossAlarm(){ tone(220,0.25,'sawtooth',0.08); setTimeout(()=>tone(180,0.25,'sawtooth',0.08), 260); }

    // ------- Help popups -------
    function attachHelpPops(){
      document.body.addEventListener('click', (e)=>{
        const t = e.target.closest('[data-help]');
        if(!t) return;
        const txt = (t.getAttribute('data-help')||'').trim(); if(!txt) return;
        const pop = document.createElement('div'); pop.className = 'help-pop'; pop.textContent = txt;
        document.body.appendChild(pop);
        const r = t.getBoundingClientRect();
        pop.style.left = (r.left + r.width/2) + 'px';
        pop.style.top  = (window.scrollY + r.top - 10) + 'px';
        setTimeout(()=>pop.remove(), 1800);
      });
    }

    // ------- Candlesticks -------
    let chart, series;
    const candleBuffers = { AAPL:[], NVDA:[], TSLA:[] };
    const CANDLE_SECONDS = 5; // new candle every 5 ticks (~5s with our 1s loop)
    let candleTick = 0;
    let currentSym = 'AAPL';

    function initChart(){
      const node = el('candleWrap');
      chart = LightweightCharts.createChart(node, {
        layout: { background: { color: 'transparent' }, textColor: '#0B0C0F' },
        grid: { vertLines: { color: 'rgba(0,0,0,.06)' }, horzLines: { color: 'rgba(0,0,0,.06)' } },
        timeScale: { timeVisible: true, secondsVisible: true },
        rightPriceScale: { borderVisible: false },
      });
      series = chart.addCandlestickSeries({
        upColor:'#0b7e2d', borderUpColor:'#0b7e2d', wickUpColor:'#0b7e2d',
        downColor:'#b00020', borderDownColor:'#b00020', wickDownColor:'#b00020'
      });

      // seed some candles
      const now = Math.floor(Date.now()/1000);
      for (const t of TICKERS){
        const px = state.quotes[t.symbol];
        const seed = [];
        for (let i=20;i>0;i--){
          seed.push({ time: now - i*CANDLE_SECONDS, open: px*0.98, high: px*1.01, low: px*0.97, close: px*0.99 });
        }
        candleBuffers[t.symbol] = seed;
      }
      series.setData(candleBuffers[currentSym]);

      // switchers
      for (const btn of document.querySelectorAll('.symBtn')){
        btn.onclick = ()=>{
          currentSym = btn.getAttribute('data-sym');
          el('chartSymbol').textContent = currentSym;
          series.setData(candleBuffers[currentSym]);
        };
      }
    }

    function updateCandlesFromQuotes(){
      candleTick++;
      const ts = Math.floor(Date.now()/1000);
      for (const t of TICKERS){
        const sym = t.symbol;
        const px = state.quotes[sym];
        const buf = candleBuffers[sym];
        if (buf.length === 0){
          buf.push({ time: ts, open:px, high:px, low:px, close:px });
          continue;
        }
        let last = buf[buf.length-1];
        if (candleTick % CANDLE_SECONDS === 0){
          last.close = px;
          const newC = { time: ts, open:px, high:px, low:px, close:px };
          buf.push(newC);
          if (sym === currentSym) series.update(newC);
        } else {
          last.high = Math.max(last.high, px);
          last.low  = Math.min(last.low, px);
          last.close = px;
          if (sym === currentSym) series.update(last);
        }
        if (buf.length > 120) buf.shift();
      }
    }

    // ------- Equity, exposure, leverage -------
    function currentExposure(){
      let exp = 0;
      for (const t of TICKERS){
        const p = state.positions[t.symbol] || { micros:0 };
        const shares = p.micros * MICRO;
        exp += shares * (state.quotes[t.symbol] || 0);
      }
      return exp;
    }
    function currentEquity(){
      let posValue = 0;
      for (const t of TICKERS){
        const p = state.positions[t.symbol] || { micros:0, avgPrice:0 };
        posValue += (p.micros * MICRO) * (state.quotes[t.symbol] || 0);
      }
      return state.balance + posValue;
    }
    function unrealizedPnL(){
      let u = 0;
      for (const t of TICKERS){
        const p = state.positions[t.symbol] || { micros:0, avgPrice:0 };
        const shares = p.micros * MICRO;
        const last = state.quotes[t.symbol] || 0;
        u += shares * (last - (p.avgPrice||0));
      }
      return u;
    }
    function updateLeverageUI(){
      const lev = state.leverage;
      const eq = currentEquity();
      const borrowed = Math.max(0, eq * (lev - 1));
      const maxExp = eq * lev;
      el("levRead").textContent = `${lev.toFixed(1)}×`;
      el("levBorrowed").textContent = `${fmt(borrowed)} Bucks`;
      el("levMaxExp").textContent = `${fmt(maxExp)} Bucks`;
    }

    // ------- Quotes loop -------
    function tickQuotes(){
      for(const s of Object.keys(state.quotes)){
        const px = state.quotes[s];
        state.quotes[s] = Math.max(1, px*(1+(Math.random()-0.5)*0.002));
      }
      state.lastUpdate = new Date();
      updateCandlesFromQuotes();
      render();
    }
    setInterval(tickQuotes, 1000);

    // ------- Trading -------
    function estimate(symbol, micros){
      const px = state.quotes[symbol]||0;
      const notional = px * MICRO * micros;
      return { notional, fee: notional*FEE_RATE, px };
    }

    function buy(symbol, micros){
      const {notional, fee, px} = estimate(symbol, micros);
      const total = notional + fee;
      // Leverage cap: exposure after this buy must be <= equity * leverage
      const exp = currentExposure();
      const eq  = currentEquity();
      const maxExp = eq * state.leverage;
      const newExp = exp + (micros * MICRO) * px;
      if (newExp > maxExp + 1e-6) return toast("Leverage cap: not enough borrowed room.");
      if(state.balance < total) return toast("Insufficient Bucks.");
      const p = state.positions[symbol] || { micros:0, avgPrice:0 };
      const newShares = p.micros*MICRO + micros*MICRO;
      const newAvg = newShares>0 ? ((p.avgPrice*(p.micros*MICRO)) + (px*(micros*MICRO))) / newShares : 0;
      state.positions[symbol] = { micros: p.micros + micros, avgPrice: newAvg };
      state.balance -= total;
      state.volume += notional;
      toast(`Bought ${micros.toLocaleString()} micros of ${symbol}.`);
      render();
    }

    function sell(symbol, micros){
      const {notional, fee, px} = estimate(symbol, micros);
      const p = state.positions[symbol] || { micros:0, avgPrice:0 };
      if(micros > p.micros) return toast("Not enough micros.");
      const proceeds = notional - fee;
      // Realized P&L for sold portion
      const sharesSold = micros * MICRO;
      const realized = sharesSold * (px - (p.avgPrice||0));
      state.realizedPnL += realized;
      state.volume += notional;

      const left = p.micros - micros;
      state.positions[symbol] = left ? { micros:left, avgPrice:p.avgPrice } : { micros:0, avgPrice:0 };
      state.balance += proceeds;

      // sounds
      const eq = currentEquity();
      if (realized > 0) playWinChime();
      if (realized < - (eq * 0.002)) playLossAlarm(); // big loss ~> alarm

      toast(`Sold ${micros.toLocaleString()} micros of ${symbol}.`);
      render();
    }

    // ------- UI wiring -------
    function updateEstimates(){
      const sym = el("symSelect").value;
      const micros = Math.max(100, parseInt(el("microsInput").value||"0",10));
      const {notional, fee} = estimate(sym, micros);
      el("estNotional").textContent = `${fmt(notional)} Bucks`;
      el("estFee").textContent = `${fmt(fee,4)} Bucks`;
    }

    function drawEquityLine(){
      const c = el("equityLine");
      const ctx = c.getContext("2d");
      const w = c.width = c.getBoundingClientRect().width | 0;
      const h = c.height;
      const arr = state.equitySeries.slice(-240);
      ctx.clearRect(0,0,w,h);
      if (arr.length < 2) return;
      const min = Math.min(...arr);
      const max = Math.max(...arr);
      const xStep = w/(arr.length-1);
      ctx.beginPath();
      arr.forEach((v,i)=>{
        const x = i*xStep;
        const y = h - ((v - min) / (max - min + 1e-9)) * (h-2) - 1;
        if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      });
      ctx.lineWidth = 2;
      ctx.strokeStyle = arr[arr.length-1] >= arr[0] ? "#0b7e2d" : "#b00020";
      ctx.stroke();
      const pct = ((arr[arr.length-1]-arr[0]) / (arr[0]||1)) * 100;
      el("equityPct").textContent = `${pct>=0?'+':''}${pct.toFixed(2)}%`;
    }

    function updateLeaders(equity){
      const base = 10_000_000;
      const rivals = [
        { handle:"phoenix", ret:0.124 },
        { handle:"quantum", ret:0.082 },
        { handle:"aurora", ret:-0.013 },
        { handle:"atlas", ret:0.034 }
      ];
      const yourRet = (equity - base)/base;
      const handle = el("handle").value || "player";
      const all = [...rivals, {handle, ret:yourRet}].sort((a,b)=>b.ret-a.ret).slice(0,5);
      el("lbRows").innerHTML = all.map((r,i)=>`
        <div class="lbRow">
          <div style="opacity:.7">#${i+1}</div>
          <div style="font-weight:600">${r.handle}</div>
          <div style="margin-left:auto;font-variant-numeric:tabular-nums">${r.ret>=0?'+':''}${(r.ret*100).toFixed(2)}%</div>
        </div>`).join("");
    }

    function render(){
      // Quotes
      el("quotes").innerHTML = TICKERS.map(t=>{
        const px = state.quotes[t.symbol];
        return `<div class="qbox">
          <div style="font-size:14px;opacity:.7">${t.symbol}</div>
          <div style="font-size:28px;font-weight:700">$${fmt(px)}</div>
          <div style="font-size:12px;opacity:.6">as of ${state.lastUpdate.toLocaleTimeString()}</div>
        </div>`;
      }).join("");

      // Portfolio rows + totals
      let posValue = 0;
      const rows = TICKERS.map(t=>{
        const p = state.positions[t.symbol] || { micros:0, avgPrice:0 };
        const shares = p.micros * MICRO;
        const last = state.quotes[t.symbol] || 0;
        const value = shares * last;
        const pnl = shares * (last - (p.avgPrice||0));
        posValue += value;
        const pnlColor = pnl >= 0 ? '#0b7e2d' : '#b00020';
        return `<div class="tableR">
          <div>${t.symbol}</div>
          <div style="text-align:right">${(p.micros||0).toLocaleString()}</div>
          <div style="text-align:right">${fmt(shares,4)}</div>
          <div style="text-align:right">$${fmt(p.avgPrice||0)}</div>
          <div style="text-align:right">$${fmt(last)}</div>
          <div style="text-align:right">${fmt(value)} Bucks</div>
          <div style="text-align:right;color:${pnlColor}">${pnl>=0?'+':''}${fmt(pnl)} Bucks</div>
        </div>`;
      }).join("");
      el("portRows").innerHTML = rows;

      const equity = state.balance + posValue;

      // Bucks labels
      el("balance").textContent  = `${fmt(state.balance)} Bucks`;
      el("equity").textContent   = `${fmt(equity)} Bucks`;
      el("balance2").textContent = `${fmt(state.balance)} Bucks`;
      el("equity2").textContent  = `${fmt(equity)} Bucks`;

      // P&L & Flow
      const uPnL = unrealizedPnL();
      el("realizedPnL").textContent  = `${fmt(state.realizedPnL)} Bucks`;
      el("unrealizedPnL").textContent = `${fmt(uPnL)} Bucks`;
      el("flowVol").textContent       = `${fmt(state.volume)} Bucks`;
      el("realizedPnL").style.color   = state.realizedPnL>=0 ? '#0b7e2d' : '#b00020';
      el("unrealizedPnL").style.color = uPnL>=0 ? '#0b7e2d' : '#b00020';

      // equity series + new high alert
      if (state.equityHigh === null) state.equityHigh = equity;
      state.equitySeries.push(equity);
      if (equity > state.equityHigh){
        state.equityHigh = equity;
        playWinAlert();
      }
      drawEquityLine();

      // leverage UI reacts to equity
      updateLeverageUI();

      // leaderboard
      updateLeaders(equity);
    }

    function toast(msg){
      const t = el("toast"); t.textContent = msg; t.style.display = "block";
      setTimeout(()=>{ t.style.display = "none"; }, 1500);
    }

    function setup(){
      // symbol dropdown
      const sel = el("symSelect");
      sel.innerHTML = TICKERS.map(t=>`<option value="${t.symbol}">${t.symbol} — ${t.name}</option>`).join("");
      sel.value = "AAPL";

      // handlers
      el("buyBtn").onclick = ()=>{ const sym=el("symSelect").value; const micros=Math.max(100, parseInt(el("microsInput").value||"0",10)); buy(sym, micros); };
      el("sellBtn").onclick = ()=>{ const sym=el("symSelect").value; const micros=Math.max(100, parseInt(el("microsInput").value||"0",10)); sell(sym, micros); };
      el("microsInput").oninput = updateEstimates;
      el("symSelect").onchange = updateEstimates;

      // leverage slider
      el("levSlider").oninput = ()=>{ state.leverage = parseFloat(el("levSlider").value); updateLeverageUI(); };

      // init
      updateEstimates();
      updateLeverageUI();
      el("year").textContent = new Date().getFullYear();

      // helpers
      attachHelpPops();
      initChart();

      // first render
      render();
    }

    // Boot
    setup();
  </script>
</body>
</html>
