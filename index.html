import React, { useEffect, useMemo, useRef, useState } from "react";

// === Utility: Simple tone generator (no external audio files) ===
function playTone({ freq = 660, duration = 300, type = "sine", volume = 0.2 }) {
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.type = type;
    osc.frequency.value = freq;
    gain.gain.value = volume;
    osc.connect(gain);
    gain.connect(ctx.destination);
    osc.start();
    setTimeout(() => {
      osc.stop();
      ctx.close();
    }, duration);
  } catch (e) {
    // Audio might be blocked until user interacts.
  }
}

function bellWinSmall() {
  playTone({ freq: 880, duration: 120, type: "triangle", volume: 0.25 });
  setTimeout(() => playTone({ freq: 1320, duration: 120, type: "triangle", volume: 0.22 }), 120);
}
function bellWinBig() {
  bellWinSmall();
  setTimeout(() => playTone({ freq: 1760, duration: 250, type: "square", volume: 0.22 }), 200);
}
function warnLoseSmall() {
  playTone({ freq: 420, duration: 180, type: "sawtooth", volume: 0.22 });
}
function warnLoseBig() {
  playTone({ freq: 240, duration: 500, type: "sawtooth", volume: 0.28 });
  setTimeout(() => playTone({ freq: 180, duration: 400, type: "sawtooth", volume: 0.28 }), 120);
}

// === SVG Candlestick Chart (no external libs) ===
function CandleChart({ data, width = 900, height = 320, padding = 40 }) {
  const w = width;
  const h = height;

  const prices = data.flatMap(d => [d.l, d.h]);
  const min = Math.min(...prices);
  const max = Math.max(...prices);
  const yScale = (p) => {
    // invert so higher prices are higher up on screen
    const t = (p - min) / (max - min || 1);
    return h - padding - t * (h - padding * 2);
  };
  const xStep = (w - padding * 2) / Math.max(1, data.length);

  return (
    <svg className="w-full" viewBox={`0 0 ${w} ${h}`}>
      {/* Axes */}
      <line x1={padding} y1={h - padding} x2={w - padding} y2={h - padding} stroke="#e5e7eb" />
      <line x1={padding} y1={padding} x2={padding} y2={h - padding} stroke="#e5e7eb" />

      {/* Price gridlines */}
      {Array.from({ length: 4 }).map((_, i) => {
        const y = padding + (i * (h - padding * 2)) / 3;
        return <line key={i} x1={padding} y1={y} x2={w - padding} y2={y} stroke="#f3f4f6" />;
      })}

      {/* Candles */}
      {data.map((d, i) => {
        const x = padding + i * xStep + xStep * 0.1;
        const cw = xStep * 0.8;
        const yOpen = yScale(d.o);
        const yClose = yScale(d.c);
        const yHigh = yScale(d.h);
        const yLow = yScale(d.l);
        const up = d.c >= d.o;
        const bodyY = Math.min(yOpen, yClose);
        const bodyH = Math.max(2, Math.abs(yClose - yOpen));
        return (
          <g key={i}>
            {/* Wick */}
            <line x1={x + cw / 2} x2={x + cw / 2} y1={yHigh} y2={yLow} stroke={up ? "#16a34a" : "#dc2626"} strokeWidth={1.5} />
            {/* Body */}
            <rect x={x} y={bodyY} width={cw} height={bodyH} fill={up ? "#22c55e" : "#ef4444"} opacity={0.9} rx={3} />
          </g>
        );
      })}

      {/* Price labels */}
      <text x={padding} y={padding - 10} className="fill-gray-500 text-xs">High {max.toFixed(2)}</text>
      <text x={padding} y={h - padding + 14} className="fill-gray-500 text-xs">Low {min.toFixed(2)}</text>
    </svg>
  );
}

// === Random OHLC generator ===
function nextBar(prevClose) {
  const drift = 0.0; // neutral drift for a sim
  const vol = 0.015; // ~1.5% per bar typical range
  const change = (Math.random() - 0.5) * 2 * vol * prevClose + drift;
  const open = prevClose + (Math.random() - 0.5) * 0.002 * prevClose;
  let close = Math.max(0.01, prevClose + change);
  const high = Math.max(open, close) + Math.random() * 0.004 * prevClose;
  const low = Math.min(open, close) - Math.random() * 0.004 * prevClose;
  const volume = Math.round( (Math.random() * 0.8 + 0.6) * 1_000_000 ); // 0.6M - 1.4M
  return { o: open, h: high, l: low, c: close, v: volume };
}

const STOCKS = [
  { sym: "AAPL", name: "Apple" },
  { sym: "TSLA", name: "Tesla" },
  { sym: "NVDA", name: "NVIDIA" },
  { sym: "MSFT", name: "Microsoft" },
  { sym: "AMZN", name: "Amazon" },
  { sym: "META", name: "Meta" },
  { sym: "GOOGL", name: "Alphabet" },
  { sym: "NFLX", name: "Netflix" },
];

export default function TradingSimCandles() {
  // Core state
  const [symbol, setSymbol] = useState(STOCKS[0].sym);
  const [bucks, setBucks] = useState(10000);
  const [leverage, setLeverage] = useState(5000); // "borrowed for the day"
  const [data, setData] = useState(() => {
    let arr = [];
    let last = 150 + Math.random() * 150; // start price
    for (let i = 0; i < 60; i++) {
      const bar = nextBar(last);
      arr.push({ ...bar, t: i });
      last = bar.c;
    }
    return arr;
  });

  const latest = data[data.length - 1];
  const [entryPrice, setEntryPrice] = useState(latest.c);
  const [inPosition, setInPosition] = useState(true);

  // Derived metrics
  const exposure = bucks + leverage; // how much capital is deployed (your cash + borrowed)
  const units = inPosition ? exposure / entryPrice : 0; // simple 100% deployment model
  const unrealizedPL = inPosition ? (latest.c - entryPrice) * units : 0;

  const totalVolume = useMemo(() => data.reduce((s, d) => s + d.v, 0), [data]);
  const avgPrice = useMemo(() => data.reduce((s, d) => s + d.c, 0) / data.length, [data]);
  const flowBucks = totalVolume * avgPrice * 1e-6; // scaled so numbers are readable
  const extractionPct = flowBucks > 0 ? Math.min(100, Math.abs(unrealizedPL) / flowBucks * 100) : 0;

  // Sound thresholds (crossing logic)
  const lastZoneRef = useRef("neutral");
  useEffect(() => {
    const pct = unrealizedPL / Math.max(1, exposure);
    let zone = "neutral";
    if (pct >= 0.010) zone = "+big";
    else if (pct >= 0.003) zone = "+small";
    else if (pct <= -0.010) zone = "-big";
    else if (pct <= -0.003) zone = "-small";

    if (zone !== lastZoneRef.current) {
      // Only chime after user interacts (to satisfy browser autoplay policies)
      if (window.__userInteracted) {
        if (zone === "+small") bellWinSmall();
        if (zone === "+big") bellWinBig();
        if (zone === "-small") warnLoseSmall();
        if (zone === "-big") warnLoseBig();
      }
      lastZoneRef.current = zone;
    }
  }, [unrealizedPL, exposure]);

  // Price feed simulation
  useEffect(() => {
    const id = setInterval(() => {
      setData(prev => {
        const last = prev[prev.length - 1];
        const bar = nextBar(last.c);
        const next = [...prev.slice(1), { ...bar, t: last.t + 1 }];
        return next;
      });
    }, 1200);
    return () => clearInterval(id);
  }, []);

  // User interaction flag for audio
  useEffect(() => {
    const onClick = () => (window.__userInteracted = true);
    window.addEventListener('click', onClick, { once: true });
    return () => window.removeEventListener('click', onClick);
  }, []);

  // Help popups (10-word explanations)
  const helpItems = [
    { key: "bucks", text: "Bucks are your in-game cash used for trading decisions." },
    { key: "leverage", text: "Leverage equals borrowed funds available only for today’s trading." },
    { key: "exposure", text: "Exposure is Bucks plus Leverage currently deployed into this trade." },
    { key: "pnl", text: "P&L shows profit or loss changing live with price." },
    { key: "flow", text: "Flow estimates total market money moving through this symbol." },
    { key: "extract", text: "Extraction shows your share captured from today’s overall trading flow." },
    { key: "candles", text: "Green closes higher than open; red closes below open." },
    { key: "volume", text: "Volume counts traded shares; higher bars mean heavier activity." },
  ];
  const [showHelp, setShowHelp] = useState(false);

  return (
    <div className="min-h-screen bg-neutral-50 text-neutral-900">
      <div className="max-w-6xl mx-auto p-4 md:p-6">
        <header className="flex items-center justify-between mb-4">
          <div>
            <h1 className="text-2xl font-semibold">Quant-Lite Simulator</h1>
            <p className="text-sm text-neutral-600">Candlesticks • Bucks • Leverage • Live P&L • Flow Extraction</p>
          </div>
          <button
            className="rounded-full shadow px-4 py-2 bg-black text-white hover:opacity-90"
            onClick={() => setShowHelp(true)}
            aria-label="Open help"
            title="Open help"
          >
            ? Help
          </button>
        </header>

        {/* Controls */}
        <div className="grid md:grid-cols-4 gap-3 mb-4">
          <div className="bg-white p-4 rounded-2xl shadow">
            <label className="text-xs uppercase tracking-wide text-neutral-500">Symbol</label>
            <select
              className="w-full mt-1 border rounded-xl p-2"
              value={symbol}
              onChange={(e) => {
                const sym = e.target.value;
                setSymbol(sym);
                // Reset price seed per symbol (simple)
                const base = 120 + Math.random() * 250;
                let arr = [];
                let last = base;
                for (let i = 0; i < 60; i++) { const bar = nextBar(last); arr.push({ ...bar, t: i }); last = bar.c; }
                setData(arr);
                setEntryPrice(arr[arr.length - 1].c);
                setInPosition(true);
              }}
            >
              {STOCKS.map(s => <option key={s.sym} value={s.sym}>{s.sym} — {s.name}</option>)}
            </select>
          </div>

          <div className="bg-white p-4 rounded-2xl shadow" title="Bucks are your in-game cash used for trading decisions.">
            <label className="text-xs uppercase tracking-wide text-neutral-500">Bucks</label>
            <input
              type="number"
              className="w-full mt-1 border rounded-xl p-2"
              value={bucks}
              min={0}
              step={100}
              onChange={(e) => setBucks(Math.max(0, Number(e.target.value)))}
            />
            <p className="text-xs text-neutral-500 mt-1">Bucks = your cash</p>
          </div>

          <div className="bg-white p-4 rounded-2xl shadow" title="Leverage equals borrowed funds available only for today’s trading.">
            <label className="text-xs uppercase tracking-wide text-neutral-500">Leverage (borrowed today)</label>
            <input
              type="range"
              min={0}
              max={100000}
              step={500}
              value={leverage}
              onChange={(e) => setLeverage(Number(e.target.value))}
              className="w-full mt-2"
            />
            <div className="flex items-baseline justify-between mt-1">
              <span className="text-sm font-medium">{leverage.toLocaleString()} Bucks</span>
              <span className="text-xs text-neutral-500">0 — 100,000</span>
            </div>
          </div>

          <div className="bg-white p-4 rounded-2xl shadow">
            <label className="text-xs uppercase tracking-wide text-neutral-500">Position</label>
            <div className="flex gap-2 mt-2">
              {inPosition ? (
                <button className="flex-1 rounded-xl bg-emerald-600 text-white py-2" onClick={() => setInPosition(false)}>Exit</button>
              ) : (
                <button className="flex-1 rounded-xl bg-blue-600 text-white py-2" onClick={() => { setEntryPrice(latest.c); setInPosition(true); }}>Enter Long</button>
              )}
              <button className="rounded-xl border px-3" onClick={() => setEntryPrice(latest.c)} title="Reset your entry at the current price">Re-Anchor</button>
            </div>
            <p className="text-xs text-neutral-500 mt-1">Deploys full exposure into a simple long position.</p>
          </div>
        </div>

        {/* KPIs */}
        <div className="grid md:grid-cols-4 gap-3 mb-4">
          <KPI label="Exposure (Bucks + Leverage)" value={exposure} fmt="money" tooltip="Exposure is Bucks plus Leverage currently deployed into this trade." />
          <KPI label="Units Held" value={units} fmt="units" tooltip="How many shares your exposure buys at entry price." />
          <KPI label="Unrealized P&L" value={unrealizedPL} fmt="pnl" tooltip="P&L shows profit or loss changing live with price." />
          <KPI label="Extraction of Flow" value={extractionPct} fmt="percent" tooltip="Your profit share relative to estimated overall market flow." />
        </div>

        {/* Chart Card */}
        <div className="bg-white rounded-2xl shadow p-4 mb-3">
          <div className="flex items-center justify-between mb-2">
            <div className="text-sm text-neutral-500">{symbol} • Live Candles (sim) • Last {data.length}</div>
            <div className="text-sm">Price: <span className="font-semibold">{latest.c.toFixed(2)}</span></div>
          </div>
          <CandleChart data={data} />
          <div className="mt-2 flex items-center justify-between text-sm text-neutral-600">
            <div title="Volume counts traded shares; higher bars mean heavier activity.">Total Volume: {totalVolume.toLocaleString()}</div>
            <div title="Flow estimates total market money moving through this symbol.">Est. Flow (scaled Bucks): {flowBucks.toFixed(2)}</div>
          </div>
        </div>

        {/* Legend / micro-tooltips */}
        <div className="flex flex-wrap gap-2 text-xs text-neutral-600 mb-10">
          <Badge text="Green candle closes above open" />
          <Badge text="Red candle closes below open" />
          <Badge text="Wick shows intrabar high and low" />
          <Badge text="Re-Anchor resets entry to current price" />
          <Badge text="Exit closes position, freezing P&L" />
        </div>

        {/* Floating Help Modal */}
        {showHelp && (
          <div className="fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center p-4 z-50" onClick={() => setShowHelp(false)}>
            <div className="bg-white w-full max-w-xl rounded-2xl shadow-xl p-5" onClick={e => e.stopPropagation()}>
              <div className="flex items-center justify-between mb-3">
                <h2 className="text-lg font-semibold">Quick Help</h2>
                <button className="rounded-full px-3 py-1 border" onClick={() => setShowHelp(false)}>Close</button>
              </div>
              <p className="text-sm text-neutral-600 mb-3">Ten-word popups explaining what you see on screen:</p>
              <div className="grid grid-cols-1 sm:grid-cols-2 gap-2">
                {helpItems.map(h => (
                  <div key={h.key} className="border rounded-xl p-3 text-sm" title={h.text}>{h.text}</div>
                ))}
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}

function KPI({ label, value, fmt = "number", tooltip }) {
  let display = String(value);
  if (fmt === "money") display = `${value < 0 ? "-" : ""}$${Math.abs(value).toLocaleString(undefined, { maximumFractionDigits: 0 })}`;
  if (fmt === "pnl") display = `${value < 0 ? "-" : "+"}$${Math.abs(value).toLocaleString(undefined, { maximumFractionDigits: 2 })}`;
  if (fmt === "percent") display = `${value.toFixed(2)}%`;
  if (fmt === "units") display = `${value.toFixed(3)}`;
  return (
    <div className="bg-white p-4 rounded-2xl shadow" title={tooltip}>
      <div className="text-xs uppercase tracking-wide text-neutral-500">{label}</div>
      <div className={`mt-1 text-xl font-semibold ${fmt === 'pnl' ? (value >= 0 ? 'text-emerald-600' : 'text-red-600') : ''}`}>{display}</div>
    </div>
  );
}

function Badge({ text }) {
  return (
    <span className="inline-flex items-center gap-1 rounded-full border px-3 py-1">{text}</span>
  );
}
